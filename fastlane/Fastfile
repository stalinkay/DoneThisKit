require 'versionomy'

lane :pods do
  cocoapods(podfile: "Example/")
end

lane :tests do
  scan(workspace: "Example/DoneThisKit.xcworkspace", scheme: "DoneThisKit-Example", clean: true)
end

lane :travis do
  pods
  tests
end

lane :push do
  github_tag = last_git_tag
  github_tag ||= "0.0.1"
  github_tag_version = Versionomy.parse(github_tag)
  version = github_tag_version.bump(:tiny).to_s
  version_bump_podspec(path: "DoneThisKit.podspec", version_number: version)
  git_commit(path: "./DoneThisKit.podspec", message: "Bump podspec to #{version}")
  changelog = changelog_from_git_commits
  github_release = set_github_release(
    repository_name: "carambalabs/DoneThisKit",
    api_token: ENV['GITHUB_TOKEN'],
    name: version,
    tag_name: version,
    description: changelog,
    commitish: "master"
  )
  push_to_git_remote(remote_branch: 'master', force: false, tags: true)
  pod_push(allow_warnings: true, verbose: true)
  pod_push(path: 'DoneThisKit.podspec', verbose: true, allow_warnings: true, repo: 'carambalabs', sources: ['https://github.com/carambalabs/Specs', 'https://github.com/CocoaPods/Specs'])
  slack(
    message: "A new version of DoneKit has been deployed",
    channel: "#notifications",
    success: true,
    payload: {
      'Build Date' => Time.new.to_s,
      'Version' => version,
    },
    default_payloads: [:git_branch, :git_author]
  )
end
